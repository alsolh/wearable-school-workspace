<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,user-scalable=no">
<title>Circular UI</title>
<link rel="stylesheet" href="lib/tau/wearable/theme/default/tau.min.css">
<link rel="stylesheet" media="all and (-tizen-geometric-shape: circle)"
	href="lib/tau/wearable/theme/default/tau.circle.min.css">
<!-- load theme file for your application -->
<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div class="ui-page ui-page-active" id="main">
		<header class="ui-header">
			<h2 class="ui-title">Wearable School</h2>
		</header>
		<div id="tizenId" style="font-size: 2em; text-align:center">Sensor Data Collection Active</div>
		<br />
		<div class="ui-content content-padding">
			<img src="images/lock.png" width="128" height="128"> <br>
			
		</div>
	</div>
	<script type="text/javascript" src="js/log4javascript.js"></script>
<script type="text/javascript">
var battery = navigator.battery || navigator.webkitBattery || navigator.mozBattery;
console.log(Math.floor(battery.level * 100) + '%');
	var log = log4javascript.getLogger(tizen.systeminfo.getCapability("http://tizen.org/system/tizenid"));
	//var log = log4javascript.getLogger();
	var consoleAppender = new log4javascript.BrowserConsoleAppender();
	var ajaxAppender = new log4javascript.AjaxAppender("http://alsolh.myqnapcloud.com:32772/watchlog/_bulk_docs");
	var layout = new log4javascript.JsonLayout(true, false);
layout.batchHeader = '{ "docs": [';
layout.batchFooter = "] }";
ajaxAppender.addHeader("Content-Type", "application/json");
ajaxAppender.setLayout(layout);
ajaxAppender.setBatchSize(5);
    var consoleLayout = new log4javascript.PatternLayout("%d{HH:mm:ss} %-5p - %m%n");
    consoleAppender.setLayout(consoleLayout);
    log.addAppender(consoleAppender);
    log.addAppender(ajaxAppender);
    //console.log("test222");
battery.onlevelchange = function () {
  log.info('The battery level is ' + battery.level);
  console.log('The battery level is ' + battery.level);
};
</script>
	<script type="text/javascript" src="lib/tau/wearable/js/tau.min.js"></script>
	<script src="js/app.js"></script>
	<script src="lowBatteryCheck.js"></script>
	<script src="js/tau-config.js"></script>
	<script src="lib/tau/wearable/js/tau.js"></script>
	<script src="js/core/core.js" data-main="./js/app.js"></script>
	<script src="js/mqttws31.js"></script>
	<script>
//setInterval(function(){tizen.systeminfo.getPropertyValue('BATTERY', onPowerSuccessCallback);}, 5000);
//function onPowerSuccessCallback(battery) {
//    /* Log the device battery level to the console */
//    if(!battery.isCharging) {
//    	log.info('The battery level is ' + battery.level);
//    	console.log('The battery level is ' + battery.level);
//    	console.log(Math.floor(battery.level * 100) + '%');
//	}
//}
var tizenId = tizen.systeminfo.getCapability("http://tizen.org/system/tizenid");
document.getElementById("tizenId").innerText = tizenId;
console.log(" tizenid = " + tizenId);

// Register Watch couchdb
    var data = {
    "_id": tizenId
};
        var req = new XMLHttpRequest();
    req.open("POST", 'http://alsolh.myqnapcloud.com:32772/watches', true);
req.setRequestHeader("Authorization", "Basic " + btoa('admin' + ":" + 'asolh787'));
    req.setRequestHeader("Content-type", "application/json");
    req.onreadystatechange = function() {
        if (this.readyState == 4) {
            console.log(this.status + ' - ' + this.responseText);
       }
    };
    req.send(JSON.stringify(data));
	
// Create a client instance
client = new Paho.MQTT.Client('alsolh.asuscomm.com', Number(32769), "clientId");

// set callback handlers
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

// connect the client
client.connect({onSuccess:onConnect});

// called when the client connects
function onConnect() {
  // Once a connection has been made, make a subscription and send a message.
  console.log("onConnect");
  client.subscribe("assessments/student1");
  //message = new Paho.MQTT.Message("Hello");
  //message.destinationName = "World";
  //client.send(message);

var i = 0;
 var id = setInterval(function()
                {
                var wLocation = {"altitude":localStorage.getItem("altitude"),"longitude":localStorage.getItem("longitude"),"latitude":localStorage.getItem("latitude")};
                  message = new Paho.MQTT.Message(JSON.stringify(wLocation));
  message.destinationName = "telemetry/student1";
  client.send(message);
            i = i + 1;
            navigator.geolocation.getCurrentPosition(showMap);
            
            },5000);

}



function showMap(position) {
      //console.log(position.coords.latitude);
      localStorage.setItem("longitude", position.coords.longitude);
      localStorage.setItem("latitude", position.coords.latitude);
    }

// called when the client loses its connection
function onConnectionLost(responseObject) {
  if (responseObject.errorCode !== 0) {
    console.log("onConnectionLost:"+responseObject.errorMessage);
  }
}

// called when a message arrives
function onMessageArrived(message) {
  console.log("onMessageArrived:"+message.payloadString);
  localStorage.setItem("question", message.payloadString);
  window.open('pages/QuestionContent.html');
}
      
    </script>
</body>
</html>
